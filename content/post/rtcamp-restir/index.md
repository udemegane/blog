---
title: "Rtcamp Restir"
date: 2023-07-18T17:18:34+09:00
draft: true
---

## 直接照明計算への応用
このRISを放射輝度推定に応用した例がBitterli[2020]らが提案したReSTIR DIです。  
ReSTIR DIではRIS目標分布として直接照明におけるレンダリング方程式のうち、可視性項$V$を除いたものを使い、またRISに対しストリーム入力を与えることができる手法WRSを用いてターゲットピクセルだけでなく前フレームからの投影したサンプル、近傍ピクセルでのサンプルも合わせて入力し分散を低減するものでした。  


## 間接照明への応用例その１: ReSTIR GI

## 間接照明への応用例その2: ReSTIR PT
ここまでの手法ではリサンプリング手法として、Talbot[2005]のRISを使用し、良好な結果を得られていました。  ただしこれが本当にUnbiasになっているかというとそうではなく、一つ落とし穴があります。それは初期サンプル$(x_i,....,x_M)$の生成において、同一のドメイン$\Omega$からの生成を仮定に置いていることです。  
SpatioTemporalな処理を行うとき、nフレーム目のi番目のピクセルにおけるドメイン$\Omega_{n,i}$があるとき、その前フレームにおけるドメイン$\Omega_{n-1,i}$と近傍ピクセルのドメイン$\Omega_{n, i_{neigbor}}$は一般的なシーンではかなり似ていたとしても、厳密には異なるものです。  
そのため、リサンプリング時のソースPDFだけでなく、ドメインも異なるものという仮定を置いてRISを再設計しなければUnbiasになりません。  

この問題について取り組んだのがLin[2022]らが提案する、GRIS(Generalized Resampled Importace Sampling)であり、このGRISを用いて光輸送経路のUnbiasな再利用を行う手法をReSTIR PTと呼びます。

### GRISの概要
あるドメイン$\Omega$上で$f$を積分するとき、つまり$\int_{\Omega}f(x)dx$があり、RISを用いてこれを推定することを考えます。  
この時、RISへの入力サンプル$x_s$が異なるドメイン$\Omega_s$からのものであるときUnbiasに計算するには、シフトマッピング関数$T_s:\Omega_s → \Omega $を使ってサンプルを$\Omega$に対応づける必要があります。  
つまり、GRISとは 任意のドメインからのサンプルを許す(当然サンプルごとに異なるPDFを持つことも許す)RISです。  

### 同一分布,同一ドメインからのRIS
基本のRISでは、あるドメイン${\Omega}について、$$M$個の初期サンプル${(x_1, ...., x_M | x_i \in \Omega)}$を、確率密度関数${p}$に基づいて発生させます。  
この時、目標分布$\hat{p}$について、i番目のサンプル$x_i$に対応するリサンプリング重み$w_i$は
$$
w_i = \frac{1}{M}\frac{\hat{p}(x_i)}{p(x_i)}
$$
と表すことができました。  
この$w_i$に基づいてサンプル列からサンプル$x_s$を選んだ時、それをそのまま候補サンプル$x_y$として使うことで(つまり$x_y=x_s$)、ある被積分関数$f$の期待値を以下のように書くことができます。ただし$_{supp}f \subset _{supp}x_y$です。

$$
\int_{\Omega}f(x)dy=\mathbb{E}[f(x_y)\frac{1}{\hat{p}(x_y)}\sum^{M}_{i=1}w_i]
$$

また$f$を重点的サンプリングと併せて使い推定値$I$を求めるときは、以下のように書くことができます。
$$
\langle{I}\rangle_{RIS} = \frac{1}{N}\sum^N_{i=1}\frac{f(x_i)}{\hat{p}(x_i)}\sum^M_{j=1}w_j
$$


### 異なる分布,同一ドメインからのRIS
先の例では、初期サンプル$(x_1,.....,x_M)$について、全て同じ$p$から発生させていましたが、サンプルごとに異なるPDF$p_i$から発生させる場合でも、和が1かつ常に0以上となる重み、
$$
\sum^M_{i=1}m_i(x)=1 , (m_i\geqq{0})
$$
を用いることでRISを使うことができます。  
Talbot[2005]はこの$m_i$として以下の式を提案しており、
$$
m_i(x)=\frac{p_i(x)}{\sum^M_{j=1}p_j(x)}
$$
これを使うと先ほどのリサンプリング重み$w_i$を以下のように書き換えることができます。
**ここわかりにくいのであとで加筆**

$$
w_i = m_i(x_i)\frac{\hat{p}(x_i)}{p_i{x_i}}
$$

### 異なる分布,異なるドメインからのRIS(GRIS)


一般にある確率変数$x$を関数$G$を使って$y$に変換するとき、つまり
$$
y = G(x)
$$
のとき、$y$のPDF$p_y$とxのPDF$p_x$の間にヤコビアン行列式を用いて以下の式が成り立ちます。
$$
p_y(y) = p_x(x)\lvert{\frac{\partial{G}}{\partial{x}}}^{-1}\rvert
$$

<br>

そのため異なるドメイン/異なるPDFからのリサンプリングをするときの重みは、同一ドメイン/異なるPDFからのリサンプリング重みのサンプルをシフトマッピング$T$で変換することを考えて、以下のように表せます。
$$
w_i = m_i(T_i(x_i))\frac{\hat{p}(T_i(x_i))}{p_i(x_i)}\lvert\frac{\partial{T_i}}{\partial{x_i}}\rvert
$$

さらに、この$w_i$を用いてサンプルから$x_s$を選んだ時、候補サンプルは$x_s$ではなく$T_i(x_s)$になります。  
GRISは、この任意のドメインに一般化されたリサンプリング重みを使ってRISをすることです。  
GRISと重点的サンプリングを使って$f$を推定するときは以下のように書くことができます。

$$
TODO
$$

ここで、既存のRISとGRISの違いを表にまとめます。

#### GRISがUnbiasであることは自明か？
ぜんぜん自明じゃないです。
これの導出は結構難解で元論文の4~6章,8ページに渡ってこれを論じています。むしろこの論文はタイトルが**Generalized Resampled Importance Sampling: Foundations of ReSTIR**とあるようにReSTIR PTだけでなくはRISを一般化することについてを主題に置いた論文です。  
ただ、正直この導出過程に関してまだあんまりよくわかっていないので割愛して結果だけ載せました。**卍**力の数学**卍**に自信のある方はぜひ元の論文を読んでみてください。  

### 光輸送経路に対するシフトマッピングの設計

### Chained GRISを用いたPath Tracing(ReSTIR PT)
