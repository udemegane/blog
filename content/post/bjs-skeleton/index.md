---
title: "babylon.jsでボーン構造を抽象化し、取り回しを良くする"
date: 2022-07-18T08:22:18+09:00
draft: false
---

# Babylon.jsゆるほめLT会に登壇しました
発表時タイトルは「bjs製の自作ポートフォリオサイト」みたいな感じだったが、**実質ボーン階層の抽象化の話になった。**
↓以下資料

{{< rawhtml >}}
<script async class="docswell-embed" src="https://www.docswell.com/assets/libs/docswell-embed/docswell-embed.min.js" data-src="https://www.docswell.com/slide/5MRDGK/embed" data-aspect="0.5625"></script><div class="docswell-link"><a href="https://www.docswell.com/s/udemegane/5MRDGK-2022-07-18-081558">babylon.jsゆるLT資料: ボーン階層を雑に扱いたい by @udemegane</a></div>
{{< /rawhtml >}}



# 本題

上記LTで発表した内容の通りだが、babylon.jsではボーン階層の抽象化の仕組み、UEでいうところのSkeletonが存在しない。

これはリギング済みキャラクターを扱う際にかなり厳しい制約であり、キャラクターアニメーションを扱いたくば一つのアセットの中に必要なアニメーション全てを含めてbjsでインポートする必要がある。<br>

再利用性皆無な上に非常に扱いにくいので、なんとかして抽象化しよう、というのが目的。UEのスケルトンのような仕組みを実現することを目指す。  <br>

とりあえずまだ突貫工事で作ったものなので、時間のある時により丁寧に作り直す＆解説を入れるつもりでいるが、おおざっぱな説明としてはボーン階層に対する部分グラフ同型問題を解く、ということに帰着する。UEのスケルトンは、rootボーンを固定した状態で、そのスーパセットないしはサブセットを互換性のある構造として認識するので、2つのボーン階層を比べたとき、その大きさが大きいほうをS_Aとすると、もう片方S_BがS_Aの部分グラフ、かつ根が同一、かつ左右が一致する、になっていればよい。<br>

ただ、これはその後の処理も考えると以外にめんどくさくて、まず左右一致判定を完全自動化するのはあまりにもめんどくさいのが一つ、もう一つは、構造一致したボーン階層に対しては、どのボーンとボーンがそれぞれ対応するかインデックスを振りたいのがもう一つ。<br>

左右一致は、例えば右腕と左腕は大抵の場合、全く同じ階層構造になっているので見分けがつかない。判断基準は名前と座標になる。
インデックス振り分けは、これはボーン構造＝根付き木を文字列変換してそれを比較するアルゴリズムが使えないこと。<br>

ちょっと対応がめんどくさいのでとりあえず今は完全一致に逃げている。<br>

後に図とかを入れた詳しい解説を書きます。。。。

